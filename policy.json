{
  "policy_version": "v1.4",
  "policy_name": "mtg-sim-integrated",
  "policy_revision": "2025-09-16",
  "created_at": "2025-09-16T00:00:00Z",
  "locale": "ja-JP",
  "format": {
    "game": "Magic: The Gathering",
    "ruleset": "Modern",
    "match_mode": "BO1",
    "mulligan": "London",
    "turn_order": "random",
    "sideboarding": {
      "allowed": false,
      "exceptions": [
        { "card": "Karn, the Great Creator", "ability": "-2", "allow_wish": true }
      ]
    }
  },
  "oracle": {
    "source_priority": ["scryfall", "gatherer"],
    "fatal_on_unresolved": true
  },
  "engine": {
    "pregame": {
      "public_reveal": {
        "enable": true,
        "cards": {
          "Devourer of Destiny": {
            "action": "reveal_in_opening_hand",
            "timing": "game_start_before_draw",
            "resolution": {
              "look_at_top": 4,
              "put_on_top": 1,
              "exile_rest": true,
              "randomize_top_if_multiple": false
            }
          }
        }
      },
      "draw_safeguards": {
        "fix_going_second_turn1_draw": true,
        "protect_draw_after_fetchland": true,
        "avoid_over_suppressing_duplicate_lands": true
      }
    },
    "mulligan_policy": {
      "type": "london",
      "keep_heuristics": {
        "DeckA": {
          "min_lands": 2,
          "must_include_one_of": [["Ragavan, Nimble Pilferer", "Guide of Souls"], ["Ocelot Pride", "Static Prison", "Galvanic Discharge"]]
        },
        "DeckB": {
          "prefer_lines": ["T2 Thought-Knot Seer via Labyrinth+Temple", "T3 Karn via Tron or Temple ramp"]
        }
      }
    },
    "casting": {
      "cost_determination_order": [
        "base_cost",
        "alternative_cost",
        "additional_costs",
        "cost_increases",
        "cost_reductions",
        "special_requirements",
        "apply_trinisphere_floor"
      ]
    },
    "mana": {
      "tap_ledger": {
        "single_use_per_source_per_turn": true,
        "cip_tapped_unusable_this_turn": true,
        "non_mana_permanent_is_not_source": true
      },
      "floating_mana": {
        "clear_on_step_change": true,
        "clear_on_phase_change": true
      },
      "color_and_c": {
        "enforce_colored_pips": true,
        "enforce_colorless_c": true
      },
      "cost_modifiers": {
        "trinisphere": {
          "enforce_minimum_three_after_all_modifiers": true,
          "scope": "spells_only",
          "floor_value": 3
        },
        "phyrexian": {
          "life_payment_allowed": true,
          "generic_mana_required_first": true,
          "cards": {
            "Dismember": { "generic_required": 1, "life_payment": 4 }
          }
        }
      }
    },
    "karn_wish": {
      "allow_sideboard_tutor": true,
      "priority": [
        { "condition": "opponent_battlefield_developed", "card": "Ensnaring Bridge" },
        { "condition": "phlage_escape_close", "card": "Tormod's Crypt" },
        { "condition": "else", "card": "Trinisphere" }
      ],
      "ignore_candidates": ["Chalice of the Void"]
    },
    "combat": {
      "attack_selection": {
        "prioritize_planeswalker_if_threat_next_turn": true,
        "threat_metric": {
          "karn_minus_two_available": 1.0,
          "bridge_lock_probability": 1.0
        },
        "evaluate_non_attack": true,
        "evaluation_weights": { "present_damage": 0.6, "future_value": 0.4 }
      },
      "block_selection": {
        "prefer_profitable_trades": true,
        "prevent_lethal": true,
        "respect_first_strike_and_damage_order": true
      }
    },
    "mechanics": {
      "track_energy": true
    },
    "error_handling": {
      "on_illegal_action": {
        "action": "replace_with_legal_alternative",
        "log": "error_and_alternative",
        "prefix": "失敗→代替行動"
      }
    },
    "pre_output_gate": {
      "enabled": true,
      "validators": [
        "mana_payment_consistency",
        "turn_mana_arithmetic",
        "cost_floor_trinisphere",
        "tap_ledger_consistency",
        "cip_tapped_usage_check",
        "color_pips_satisfied",
        "colorless_c_satisfied",
        "float_mana_nonnegative",
        "life_payment_accounted",
        "shock_fetch_life_adjustment",
        "casting_window_legality",
        "combat_legality",
        "pw_loyalty_math"
      ],
      "on_failure": {
        "action": "replace_with_legal_alternative",
        "log": "error_and_alternative",
        "prefix": "失敗→代替行動"
      }
    },
    "logging": {
      "include": [
        "initial_hand",
        "draws",
        "lands_played",
        "spells_cast",
        "combat",
        "life_changes",
        "errors",
        "energy_counters"
      ],
      "life_change_reasons": true
    },
    "heuristics_update": {
      "frequency_games": 10,
      "adjustments": [
        { "name": "tks_exile_priority", "increase_targets": ["Static Prison"], "decrease_targets": ["Goblin Bombardment"] },
        { "name": "ragavan_preemptive_removal", "enable": true },
        { "name": "discharge_alloc_to_pw", "enable": true }
      ]
    }
  },
  "tests": {
    "scenarios": [
      {
        "name": "Tron → Karn → Trinisphere same turn; Relic blocked",
        "battlefield": {
          "you": {"lands": ["Urza's Mine", "Urza's Power Plant", "Urza's Tower"], "artifacts": []},
          "opponent": {"battlefield": []}
        },
        "hand": {"you": ["Karn, the Great Creator", "Relic of Progenitus"]},
        "library": {"you": ["Trinisphere"]},
        "assert": [
          {"type": "cast", "card": "Karn, the Great Creator", "legal": true, "pay": "{4}"},
          {"type": "tutor", "card": "Trinisphere"},
          {"type": "cast", "card": "Trinisphere", "legal": true, "pay": "{3}"},
          {"type": "cast", "card": "Relic of Progenitus", "legal": false, "reason": "insufficient_mana_after_spending"}
        ]
      },
      {
        "name": "Devourer under Tron; cast trigger",
        "hand": {"you": ["Devourer of Destiny"]},
        "battlefield": {"you": {"lands": ["Urza's Mine", "Urza's Power Plant", "Urza's Tower"], "artifacts": ["Trinisphere"]}},
        "assert": [
          {"type": "cast", "card": "Devourer of Destiny", "legal": true, "pay": "{7}"},
          {"type": "trigger", "source": "Devourer of Destiny", "trigger": "cast", "effect": "exile target colored permanent"}
        ]
      },
      {
        "name": "Dismember requires {1} + 4 life",
        "battlefield": {"you": {"lands": ["Forest"], "life": 10}},
        "hand": {"you": ["Dismember"]},
        "assert": [
          {"type": "cast", "card": "Dismember", "legal": true, "pay": "{1}+4life"}
        ]
      }
    ]
  },
  "changelog": [
    {
      "rev": "2025-09-16",
      "summary": "Trinisphere下限の厳格化、タップ帳と浮きマナ消去、Devourerのプリゲーム公開、Karnの-2優先ロジック、PW優先アタック、出力前ゲート強化。"
    }
  ]
}
